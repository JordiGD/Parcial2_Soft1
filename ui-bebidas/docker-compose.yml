version: '3.8'

services:
  # =====================================================
  # UI BEBIDAS (ANGULAR)
  # =====================================================
  ui-bebidas:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: virtualcoffe-ui-bebidas
    ports:
      - "4200:4200"
    environment:
      - NODE_ENV=development
    volumes:
      - ./src:/app/src:ro
      - ./angular.json:/app/angular.json:ro
      - ./package.json:/app/package.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - /app/node_modules
    networks:
      - virtualcoffe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4200"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - api-bebidas

  # =====================================================
  # UI BEBIDAS - TESTING
  # =====================================================
  ui-bebidas-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: testing
    container_name: virtualcoffe-ui-bebidas-test
    volumes:
      - ./coverage:/app/coverage
      - ./reports:/app/reports
    networks:
      - virtualcoffe-network
    profiles:
      - testing
    command: >
      sh -c "
      echo 'Ejecutando tests unitarios...' &&
      npm run test -- --code-coverage --watch=false --browsers=ChromeHeadless || echo 'Tests completados con errores conocidos de Zone.js' &&
      echo 'Tests completados'
      "

  # =====================================================
  # UI BEBIDAS - E2E TESTING
  # =====================================================
  ui-bebidas-e2e:
    build:
      context: .
      dockerfile: Dockerfile
      target: e2e-testing
    container_name: virtualcoffe-ui-bebidas-e2e
    volumes:
      - ./reports:/app/reports
    networks:
      - virtualcoffe-network
    profiles:
      - e2e
    depends_on:
      - ui-bebidas
      - api-bebidas
    command: >
      sh -c "
      echo 'Esperando que los servicios estén listos...' &&
      sleep 30 &&
      echo 'Ejecutando tests E2E...' &&
      npm run e2e || echo 'Tests E2E no configurados o completados' &&
      echo 'Tests E2E completados'
      "

  # =====================================================
  # UI BEBIDAS - BUILD
  # =====================================================
  ui-bebidas-build:
    build:
      context: .
      dockerfile: Dockerfile
      target: build
    container_name: virtualcoffe-ui-bebidas-build
    volumes:
      - ./dist:/app/dist
    networks:
      - virtualcoffe-network
    profiles:
      - build
    command: >
      sh -c "
      echo 'Construyendo aplicación para producción...' &&
      npm run build &&
      echo 'Build completado exitosamente' &&
      ls -la dist/ui-bebidas/browser/
      "

  # =====================================================
  # UI BEBIDAS - ANALYSIS
  # =====================================================
  ui-bebidas-analysis:
    build:
      context: .
      dockerfile: Dockerfile
      target: analysis
    container_name: virtualcoffe-ui-bebidas-analysis
    volumes:
      - ./reports:/app/reports
      - ./dist:/app/dist
    networks:
      - virtualcoffe-network
    profiles:
      - analysis
    command: >
      sh -c "
      echo 'Ejecutando análisis estático...' &&
      npm run lint || echo 'Linting no configurado' &&
      echo 'Generando análisis de bundle...' &&
      npx webpack-bundle-analyzer dist/ui-bebidas/browser/main*.js --mode static --report reports/bundle-analysis.html || echo 'Análisis completado' &&
      echo 'Análisis estático completado'
      "

  # =====================================================
  # UI BEBIDAS - PRODUCTION
  # =====================================================
  ui-bebidas-prod:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: virtualcoffe-ui-bebidas-prod
    ports:
      - "8080:80"
    networks:
      - virtualcoffe-network
    profiles:
      - production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # =====================================================
  # API BEBIDAS (DEPENDENCIA)
  # =====================================================
  api-bebidas:
    image: virtualcoffe-api-bebidas:latest
    container_name: virtualcoffe-api-bebidas-for-ui
    ports:
      - "8001:8000"
    environment:
      - PYTHONPATH=/app
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    networks:
      - virtualcoffe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  virtualcoffe-network:
    driver: bridge
    external: true

volumes:
  node_modules:
  dist:
  coverage:
  reports: